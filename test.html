<!DOCTYPE html>
<html lang="en">
    <head>
        <style>
            h1 {
                font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                text-align: center;
            }
            canvas {
                border: 2px solid red;
                border-color:black;
                image-rendering: pixelated;
                border-radius:3px;
                width: 960px;
                height: 720px;
            }
            div {
                display: flex;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <h1>Hello World!</h1>
        <p id="gameTime"></p>
        <div>
            <canvas id="downSyndrome"></canvas>
        </div>
        <script>
            const canvas = document.getElementById("downSyndrome");
            const ctx = canvas.getContext("2d");
            let loop;
            const INTER_BULLET_COLLISIONS = true;
            const explosion = new Audio("explosion.wav");
            const hitSpawner = new Audio("blipSelect.wav");
            const bulletFire = new Audio("pew.wav");
            const ouch = new Audio("hitHurt.wav");
            const rocket = new Audio("rocket.wav");
            const bgMusic = new Audio("randomSoundGen.wav")
            const BULLET_SPAWN_RATE = 2000;
            const SPAWNER_SPAWN_RATE = 10000;

            gameTime = 0;
            canvas.width = 480;
            canvas.height = 360;

            bullets = [];
            spawners = [];
            class FX {
                shakeX = 0;
                shakeY = 0;
            }
            fx = new FX;
            input = [["ArrowLeft", false], ["ArrowRight", false], ["ArrowUp", false], ["ArrowDown", false], ["Space", false]];

            function drawPlayer(sprite) {
                ctx.fillStyle = sprite.color;
                ctx.save()
                ctx.translate(sprite.x-fx.shakeX, sprite.y-fx.shakeY);
                ctx.rotate(-Math.atan2(sprite.xvel, sprite.yvel));
                ctx.lineWidth = 4;
                if (sprite.image.src == "") {
                    ctx.fillRect(-sprite.size/2, -sprite.size/2, sprite.size, sprite.size); 
                    
                    ctx.strokeRect(-sprite.size/2, -sprite.size/2, sprite.size, sprite.size);
                }
                else {
                    ctx.beginPath();
                    ctx.lineWidth = 9;
                    ctx.moveTo(-(sprite.size-ctx.lineWidth)/2, -(sprite.size-ctx.lineWidth)/2);
                    ctx.lineTo(0, (sprite.size-ctx.lineWidth)/2);
                    ctx.lineTo((sprite.size-ctx.lineWidth)/2, -(sprite.size-ctx.lineWidth)/2);
                    ctx.lineTo(-(sprite.size-ctx.lineWidth)/2, -(sprite.size-ctx.lineWidth)/2);
                    ctx.lineTo(0, (sprite.size-ctx.lineWidth)/2);
                    ctx.moveTo(0, 0);
                    ctx.stroke()
                    ctx.closePath();
                    ctx.fill();

                }
                ctx.restore()
            }

            function shakeScreen(amount, fade) {
                try {
                clearInterval(screenShake);
                }
                catch {
                    console.log("no previous screenshake");
                }
                screenShake = setInterval(function() {
                    fx.shakeX = Math.random()*amount;
                    fx.shakeY = Math.random()*amount;
                    amount -= fade;
                    if (amount <= 0) {
                        fx.shakeX = 0;
                        fx.shakeY = 0;
                        clearInterval(screenShake);
                    }
                }, 10);
            }

            function pauseDuration(time) {
                clearInterval(loop);
                console.log("Whoops!");
                setTimeout(function() {loop = setInterval(gameLoop, 1); explosion.play();}, time);
            }
            function tickPhysics(sprite, friction) {
                sprite.xvel = sprite.xvel/friction;
                sprite.yvel = sprite.yvel/friction;
                sprite.x += sprite.xvel;
                sprite.y += sprite.yvel;
                sprite.yvel += sprite.Ygravity;
                sprite.xvel += sprite.Xgravity;
                return sprite;
            }
            function tickBulletLogic(sprite, playerSprite, gravity) {
                let dir = Math.atan2(playerSprite.y-sprite.y, playerSprite.x-sprite.x);
                sprite.Xgravity = Math.cos(dir)*0.01*gravity;
                sprite.Ygravity = Math.sin(dir)*0.01*gravity;
                return sprite;
            }
            function tickPlayerLogic(playerSprite, acceleration) {
                playerSprite.xvel = 0;
                playerSprite.yvel = 0;
                if (input[0][1]) {
                    playerSprite.xvel -= acceleration;
                }
                if (input[1][1]) {
                    playerSprite.xvel += acceleration;
                }
                if (input[2][1]) {
                    playerSprite.yvel -= acceleration;
                }
                if (input[3][1]) {
                    playerSprite.yvel += acceleration;
                }
                return playerSprite;
            }
            function spawnBullet(xpos, ypos) {
                bullets.push(new Sprite);
                bullets[bullets.length-1].x = xpos;
                bullets[bullets.length-1].y = ypos;
                bullets[bullets.length-1].color = "red";
                bullets[bullets.length-1].timeOfBirth = gameTime;
                bullets[bullets.length-1].image.src = "Bomb.png";
            }
            function spawnSpawner(xpos, ypos) {
                spawners.push(new Sprite);
                spawners[spawners.length-1].x = xpos;
                spawners[spawners.length-1].y = ypos;
                spawners[spawners.length-1].color = "yellow";
            }


            function isColliding(sprite1, sprite2) {
                //checks collisions
                if (sprite1.x + sprite1.size <= sprite2.x || sprite1.x >= sprite2.x + sprite2.size || sprite1.y + sprite1.size <= sprite2.y || sprite1.y >= sprite2.y + sprite2.size) {
                    return false;
                }
                else {
                    return true;
                }
            }
            //Literally ASS input logic
            document.addEventListener("keydown", function(event){
                switch (event.key) {
                    case ("ArrowLeft"): {
                        input[0][1] = true;
                        break;
                    }
                    case ("ArrowRight"): {
                        input[1][1] = true;
                        break;
                    }
                    case ("ArrowUp"): {
                        input[2][1] = true;
                        break;
                    }
                    case ("ArrowDown"): {
                        input[3][1] = true;
                        break;
                    }
                    case (" "): {
                        input[4][1] = true;
                        break;
                    }
                }
            });
            document.addEventListener("keyup", function(event){
                switch (event.key) {
                    case ("ArrowLeft"): {
                        input[0][1] = false;
                        break;
                    }
                    case ("ArrowRight"): {
                        input[1][1] = false;
                        break;
                    }
                    case ("ArrowUp"): {
                        input[2][1] = false;
                        break;
                    }
                    case ("ArrowDown"): {
                        input[3][1] = false;
                        break;
                    }
                    case (" "): {
                        input[4][1] = false;
                        break;
                    }
                }
            });


            // Create Player Character
            class Sprite {

                //Sets special values
                image = new Image();
                color = "green";
                size = 16;
                Xgravity = 0;
                Ygravity = 0;

                //Centers the Cube
                x = 130;
                y = 60;

                //Defines X and Y velocities
                xvel = 0;
                yvel = 0;

                //this is to be iterated every frame
                timeOfBirth = 0;
                
            }

            //New Player Sprite
            TMC = new Sprite;
            spawnSpawner(Math.random()*480, Math.random()*360);
            //Main Loop
            function gameLoop() {
                bgMusic.play();
                if(bullets.length > 0) {
                    rocket.play();
                }
                else {
                    rocket.pause();
                }
                ctx.clearRect(0,0,canvas.width, canvas.height);
                gameTime += 0.1;
                document.getElementById("gameTime").innerText = "GameTime:" + gameTime;
                drawPlayer(TMC);
                if (input[4][1]) {
                    console.log("NEW BULLET")
                    input[4][1] = false;
                    spawnBullet(130, 50);
                }
                TMC = tickPlayerLogic(TMC, 2)
                TMC = tickPhysics(TMC, 1)
                if (bullets.length == 0) {
                    gameTime = 0;
                }
                for (let spawner = 0; spawner < spawners.length; spawner++) {
                    drawPlayer(spawners[spawner]);
                }
                for (let bullet = 0; bullet < bullets.length; bullet++) {
                    if (bullet > bullets.length) {
                        break;
                    }
                    drawPlayer(bullets[bullet]);
                    bullets[bullet] = tickPhysics(bullets[bullet], 1.005);
                    bullets[bullet] = tickBulletLogic(bullets[bullet], TMC, 5);
                    
                    if (isColliding(bullets[bullet], TMC)) {
                        bullets.splice(bullet, 1);
                        ouch.play();
                        TMC.x = 0;
                    }
                    if (gameTime - bullets[bullet].timeOfBirth <= 6) {
                        bullets[bullet].color = "blue"
                    }
                    else {
                        bullets[bullet].color = "red"
                    }
                    for (let spawner = 0; spawner < spawners.length; spawner++) {
                        if(isColliding(bullets[bullet], spawners[spawner]) && gameTime-bullets[bullet].timeOfBirth > 6) {
                            spawners.splice(spawner, 1);
                            bullets.splice(bullet, 1);
                            rocket.pause();
                            hitSpawner.play();
                            pauseDuration(500);
                            shakeScreen(67, 0.5);
                        }
                    }
                    for (let cbullet = 0; cbullet < bullets.length; cbullet++) {
                        if (bullet > bullets.length) {
                            break;
                        }
                        if (isColliding(bullets[bullet], bullets[cbullet]) && bullet != cbullet && INTER_BULLET_COLLISIONS && (bullets[bullet].timeOfBirth > 6 ||bullets[cbullet].timeOfBirth > 6)) {
                            bullets.splice(bullet, 1);
                            explosion.pause();
                            explosion.play();
                            bullets.splice(cbullet, 1);
                        }
                    }
                }
                
            }
            loop = setInterval(gameLoop, 1);
            setInterval(function() {
                for (let spawner = 0; spawner < spawners.length; spawner++) {
                    spawnBullet(spawners[spawner].x, spawners[spawner].y);
                    bulletFire.play();
                    console.log("PEW");
                }
            }, BULLET_SPAWN_RATE);
            setInterval(function() {
                console.log("new spawner")
                spawnSpawner(Math.random()*480, Math.random()*360);
            }, SPAWNER_SPAWN_RATE);
        </script>
    </body>

</html>